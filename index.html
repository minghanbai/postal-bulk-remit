<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大宗郵政跨行匯款小幫手 (v20)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Word Generation Libraries (Docxtemplater, PizZip, FileSaver) -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .vendor-item { transition: all 0.2s ease; cursor: pointer; }
        .vendor-item.active { background-color: #eff6ff; border-color: #3b82f6; transform: translateX(4px); }
        
        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        /* Hide number arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icons ---
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>;
        const IconUsers = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" /></svg>;
        const IconArrow = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>;
        const IconDisk = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>;
        const IconClose = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>;
        const IconDatabase = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>;
        const IconChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-3 h-3"><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>;
        const IconChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-3 h-3"><path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>;
        const IconFileWord = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-yellow-500"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>;
        const IconExternalLink = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>;
        const IconTable = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25v1.5c0 .621.504 1.125 1.125 1.125m17.25-2.625h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125v1.5c0 .621-.504 1.125-1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125-1.125 1.125M12 10.875v1.5m0 1.5c0 .621-.504 1.125-1.125 1.125m1.125-1.125c.621 0 1.125.504 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125" /></svg>;

        const App = () => {
            const defaultPayees = [];
            const defaultSettings = {
                remitterName: '', remitterId: '', remitterZip: '',
                remitterAddr: '', remitterPhone: '',
                agentName: '', agentId: '', agentPhone: ''
            };
            const TEMPLATE_FILENAME = "template.docx";

            const getStoragePref = () => {
                const pref = localStorage.getItem('remit_pref_storage');
                return pref === 'true';
            };

            const [storageEnabled, setStorageEnabled] = useState(getStoragePref);

            const [payees, setPayees] = useState(() => {
                if (!getStoragePref()) return defaultPayees;
                const saved = localStorage.getItem('remit_payees');
                return saved ? JSON.parse(saved) : defaultPayees;
            });

            const [settings, setSettings] = useState(() => {
                if (!getStoragePref()) return defaultSettings;
                const saved = localStorage.getItem('remit_settings');
                return saved ? JSON.parse(saved) : defaultSettings;
            });

            const [batchItems, setBatchItems] = useState(() => {
                if (!getStoragePref()) return [];
                const saved = localStorage.getItem('remit_batch_items');
                return saved ? JSON.parse(saved) : [];
            });

            const [isBackupOpen, setIsBackupOpen] = useState(() => {
                if (!getStoragePref()) return true;
                const saved = localStorage.getItem('remit_ui_backup');
                return saved !== null ? JSON.parse(saved) : true;
            });

            const [isSettingsOpen, setIsSettingsOpen] = useState(() => {
                if (!getStoragePref()) return true;
                const saved = localStorage.getItem('remit_ui_settings');
                return saved !== null ? JSON.parse(saved) : true;
            });

            const [isVendorMgrOpen, setIsVendorMgrOpen] = useState(() => {
                if (!getStoragePref()) return true;
                const saved = localStorage.getItem('remit_ui_vendor');
                return saved !== null ? JSON.parse(saved) : true;
            });

            const [isInstructionsOpen, setIsInstructionsOpen] = useState(() => {
                if (!getStoragePref()) return false;
                const saved = localStorage.getItem('remit_ui_instructions');
                return saved !== null ? JSON.parse(saved) : false;
            });

            const [userManuallyClosedInstructions, setUserManuallyClosedInstructions] = useState(() => {
                if (!getStoragePref()) return false;
                const saved = localStorage.getItem('remit_ui_instructions_manual_close');
                return saved !== null ? JSON.parse(saved) : false;
            });

            const [vendorForm, setVendorForm] = useState({ name: '', bank: '', branch: '', code: '', account: '' });
            const [editingVendorId, setEditingVendorId] = useState(null);
            const [selectedPayeeId, setSelectedPayeeId] = useState('');
            const [amount, setAmount] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            
            const jsonInputRef = useRef(null);
            const batchFileInputRef = useRef(null);
            const vendorFileInputRef = useRef(null);
            const templateInputRef = useRef(null); // Fallback for Word template

            // --- Persistence Effects ---
            useEffect(() => {
                localStorage.setItem('remit_pref_storage', storageEnabled);
                if (!storageEnabled) {
                    localStorage.removeItem('remit_payees');
                    localStorage.removeItem('remit_settings');
                    localStorage.removeItem('remit_batch_items');
                    localStorage.removeItem('remit_ui_backup');
                    localStorage.removeItem('remit_ui_settings');
                    localStorage.removeItem('remit_ui_vendor');
                    localStorage.removeItem('remit_ui_instructions');
                    localStorage.removeItem('remit_ui_instructions_manual_close');
                } else {
                    localStorage.setItem('remit_payees', JSON.stringify(payees));
                    localStorage.setItem('remit_settings', JSON.stringify(settings));
                    localStorage.setItem('remit_batch_items', JSON.stringify(batchItems));
                    localStorage.setItem('remit_ui_backup', JSON.stringify(isBackupOpen));
                    localStorage.setItem('remit_ui_settings', JSON.stringify(isSettingsOpen));
                    localStorage.setItem('remit_ui_vendor', JSON.stringify(isVendorMgrOpen));
                    localStorage.setItem('remit_ui_instructions', JSON.stringify(isInstructionsOpen));
                    localStorage.setItem('remit_ui_instructions_manual_close', JSON.stringify(userManuallyClosedInstructions));
                }
            }, [storageEnabled]);

            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_payees', JSON.stringify(payees)); }, [payees, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_settings', JSON.stringify(settings)); }, [settings, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_batch_items', JSON.stringify(batchItems)); }, [batchItems, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_ui_backup', JSON.stringify(isBackupOpen)); }, [isBackupOpen, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_ui_settings', JSON.stringify(isSettingsOpen)); }, [isSettingsOpen, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_ui_vendor', JSON.stringify(isVendorMgrOpen)); }, [isVendorMgrOpen, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_ui_instructions', JSON.stringify(isInstructionsOpen)); }, [isInstructionsOpen, storageEnabled]);
            useEffect(() => { if (storageEnabled) localStorage.setItem('remit_ui_instructions_manual_close', JSON.stringify(userManuallyClosedInstructions)); }, [userManuallyClosedInstructions, storageEnabled]);

            const padLeft = (str, len) => {
                const s = String(str || "");
                if (s.length >= len) return s;
                return "0".repeat(len - s.length) + s;
            };

            const s2ab = (s) => {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i !== s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            };

            const moveItem = (index, direction) => {
                const newItems = [...batchItems];
                if (direction === -1 && index > 0) {
                    [newItems[index], newItems[index - 1]] = [newItems[index - 1], newItems[index]];
                } else if (direction === 1 && index < newItems.length - 1) {
                    [newItems[index], newItems[index + 1]] = [newItems[index + 1], newItems[index]];
                }
                setBatchItems(newItems);
            };

            const updateItemAmount = (id, newAmt) => {
                setBatchItems(prev => prev.map(item => 
                    item.id === id ? { ...item, amount: newAmt } : item
                ));
            };

            const toggleInstructions = () => {
                const nextState = !isInstructionsOpen;
                setIsInstructionsOpen(nextState);
                if (!nextState) {
                    setUserManuallyClosedInstructions(true);
                }
            };

            const cleanCode = (raw) => String(raw || "").trim();
            const cleanAccount = (raw) => String(raw || "").trim();
            const formatForExcel = (val) => val ? `="${val}"` : "";

            const handleExportCSV = () => {
                if (!userManuallyClosedInstructions) setIsInstructionsOpen(true);
                if(batchItems.length === 0) return;
                
                // Logic kept from original
                let headers = ["NO", "Payee", "Bank", "Branch", "Code", "Acct", "AcctSp", "Amt", "RName", "RID", "RZip", "RAddr", "RTel", "AName", "AID", "ATel"];
                for(let i=1; i<=5; i++) headers.push(`RZip_${i}`); 
                for(let i=1; i<=7; i++) headers.push(`B${i}`);     
                for(let i=1; i<=14; i++) headers.push(`A${i}`);
                let data = [headers];

                batchItems.forEach((item, index) => {
                    const rawCode = String(item.code || "");
                    const rawAcc = String(item.account || "");
                    const excelSafeCode = formatForExcel(rawCode);
                    const excelSafeAccount = formatForExcel(rawAcc);
                    const spacedAccount = rawAcc.split('').join(' ');
                    const pageNo = (index % 7) + 1;
                    const rawZip = String(settings.remitterZip || "");
                    const cleanZip = rawZip.replace(/[^0-9]/g, ''); 
                    const rawAmt = String(item.amount).replace(/[^0-9]/g, '');

                    let rowData = [
                        pageNo, item.name, item.bank, item.branch, excelSafeCode, excelSafeAccount, spacedAccount, rawAmt,
                        settings.remitterName, settings.remitterId, rawZip, settings.remitterAddr, settings.remitterPhone,
                        settings.agentName, settings.agentId, settings.agentPhone
                    ];
                    for(let i=0; i<5; i++) rowData.push(cleanZip[i] || ' ');
                    for(let i=0; i<7; i++) rowData.push(rawCode[i] || '');
                    for(let i=0; i<14; i++) rowData.push(rawAcc[i] || '');
                    data.push(rowData);
                });

                // Add empty rows if needed for remainder
                const remainder = batchItems.length % 7;
                if (remainder !== 0) {
                    const emptyRows = 7 - remainder;
                    const rawZip = String(settings.remitterZip || "");
                    const cleanZip = rawZip.replace(/[^0-9]/g, '');
                    for (let i = 0; i < emptyRows; i++) {
                        const pageNo = remainder + i + 1;
                        let emptyRowData = [pageNo, "", "", "", "", "", "", "", settings.remitterName, settings.remitterId, rawZip, settings.remitterAddr, settings.remitterPhone, settings.agentName, settings.agentId, settings.agentPhone];
                        for(let j=0; j<5; j++) emptyRowData.push(cleanZip[j] || ' ');
                        for(let j=0; j<21; j++) emptyRowData.push("");
                        data.push(emptyRowData);
                    }
                }
                
                try {
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    const bom = "\uFEFF";
                    const blob = new Blob([bom + csv], { type: "text/csv;charset=utf-8" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `匯款資料_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) { alert("匯出失敗：" + e.message); }
            };

            // --- Word Generation Logic ---
            const handleGenerateWord = () => {
                if (batchItems.length === 0) return;
                
                // 1. Try to fetch template automatically
                fetch(TEMPLATE_FILENAME)
                    .then(response => {
                        if (!response.ok) throw new Error("Template not found");
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        processWordGeneration(arrayBuffer);
                    })
                    .catch(err => {
                        console.error("Auto-load failed:", err);
                        // Fallback: Trigger hidden file input
                        if(confirm(`無法自動載入 '${TEMPLATE_FILENAME}' (可能因瀏覽器安全限制或檔案不存在)。\n\n是否手動選擇範本檔？`)) {
                            templateInputRef.current.click();
                        }
                    });
            };

            const handleTemplateSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => processWordGeneration(evt.target.result);
                reader.readAsArrayBuffer(file);
                e.target.value = ''; // Reset
            };

           // --- Word Generation Logic (DOMParser 版 - 無強制分頁) ---
            const processWordGeneration = (arrayBuffer) => {
                try {
                    const ROWS_PER_PAGE = 7;
                    const chunks = [];
                    for (let i = 0; i < batchItems.length; i += ROWS_PER_PAGE) {
                        chunks.push(batchItems.slice(i, i + ROWS_PER_PAGE));
                    }

                    // Helper: ID Sanitization (防止多頁合併時 ID 重複導致 Word 錯誤)
                    const sanitizeNode = (node, offset) => {
                        if (node.nodeType !== 1) return; // 僅處理 Element
                        
                        // 1. 修復圖片/圖形 ID (wp:docPr)
                        const docPrs = node.getElementsByTagName('wp:docPr');
                        for (let i = 0; i < docPrs.length; i++) {
                            const oldId = docPrs[i].getAttribute('id');
                            if (oldId) docPrs[i].setAttribute('id', parseInt(oldId) + offset);
                        }
                        
                        // 2. 修復書籤 ID (w:bookmarkStart)
                        const bookmarks = node.getElementsByTagName('w:bookmarkStart');
                        for (let i = 0; i < bookmarks.length; i++) {
                            const oldId = bookmarks[i].getAttribute('w:id');
                            if (oldId) bookmarks[i].setAttribute('w:id', parseInt(oldId) + offset);
                        }
                    };

                    // 第一步：利用 docxtemplater 為每一頁數據生成獨立的 XML 字串
                    const chunkXmls = chunks.map((chunk) => {
                        const zip = new PizZip(arrayBuffer.slice(0)); 
                        const doc = new window.docxtemplater(zip, { 
                            paragraphLoop: true, 
                            linebreaks: true,
                            nullGetter: () => "" 
                        });
                        
                        const pageData = preparePageData(chunk);
                        doc.render(pageData);
                        
                        return doc.getZip().file("word/document.xml").asText();
                    });

                    // 第二步：使用 DOMParser 進行結構化合併
                    const parser = new DOMParser();
                    const serializer = new XMLSerializer();
                    
                    // 解析第一頁作為「主文檔」(Master)
                    const masterDoc = parser.parseFromString(chunkXmls[0], "text/xml");
                    const masterBody = masterDoc.getElementsByTagName("w:body")[0];
                    
                    // 尋找主文檔的結尾屬性 (Section Properties)
                    let masterSectPr = null;
                    const bodyChildren = masterBody.childNodes;
                    for (let i = 0; i < bodyChildren.length; i++) {
                        if (bodyChildren[i].nodeName === "w:sectPr") {
                            masterSectPr = bodyChildren[i];
                            break;
                        }
                    }

                    // 循環處理第二頁之後的內容
                    for (let i = 1; i < chunkXmls.length; i++) {
                        const chunkDoc = parser.parseFromString(chunkXmls[i], "text/xml");
                        const chunkBody = chunkDoc.getElementsByTagName("w:body")[0];
                        const chunkNodes = Array.from(chunkBody.childNodes);
                        
                        // --- 修改點：已移除「插入分頁符號」的程式碼 ---
                        // 因為您的單頁內容很滿，讓 Word 自然換頁即可，避免產生空白頁。

                        // 設定 ID 偏移量 (每頁增加 50000，確保不重複)
                        const ID_OFFSET = i * 50000; 
                        
                        // 複製並插入節點
                        chunkNodes.forEach(node => {
                            // 排除 sectPr (每一頁的結尾屬性)，我們只保留最後一頁的屬性即可
                            if (node.nodeName !== "w:sectPr") {
                                // 重要：將節點從副文檔轉移到主文檔
                                const importedNode = masterDoc.importNode(node, true);
                                
                                // 執行 ID 清洗
                                sanitizeNode(importedNode, ID_OFFSET);
                                
                                // 插入到主文檔 (插在最後的 sectPr 之前)
                                if (masterSectPr) {
                                    masterBody.insertBefore(importedNode, masterSectPr);
                                } else {
                                    masterBody.appendChild(importedNode);
                                }
                            }
                        });
                    }

                    // 第三步：寫回 Zip 並下載
                    const finalXML = serializer.serializeToString(masterDoc);
                    const finalZip = new PizZip(arrayBuffer.slice(0));
                    finalZip.file("word/document.xml", finalXML);

                    const out = finalZip.generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });
                    saveAs(out, `大宗匯款單_自動生成_${new Date().toISOString().slice(0,10)}.docx`);

                } catch (error) {
                    alert("生成 Word 失敗：" + error.message);
                    console.error(error);
                }
            };

            const preparePageData = (chunk) => {
                const cleanZip = String(settings.remitterZip || "").replace(/[^0-9]/g, '');
                const baseData = {
                    RName: settings.remitterName,
                    RID: settings.remitterId,
                    RAddr: settings.remitterAddr,
                    RTel: settings.remitterPhone,
                    RZip: settings.remitterZip, // Full Zip
                    AName: settings.agentName,
                    AID: settings.agentId,
                    ATel: settings.agentPhone // Added Agent Phone
                };
                
                // Add split zip
                for(let k=1; k<=5; k++) baseData[`RZip_${k}`] = cleanZip[k-1] || "";

                // Fill vendor rows
                for (let j = 0; j < 7; j++) {
                    const item = chunk[j];
                    const idx = j + 1;
                    const suffix = `_${idx}`;

                    if (item) {
                        // Smart Bank Name
                        let bankText = item.bank || "";
                        if (!bankText) bankText = "銀行"; // Default
                        
                        // Smart Branch Name
                        let branchText = item.branch || "";
                        if (!branchText) {
                            branchText = "      分行"; 
                        } else {
                            if (!branchText.endsWith("分行")) branchText += "分行";
                        }

                        // Amount formatting
                        let fmtAmt = "";
                        if (item.amount) fmtAmt = Number(item.amount).toLocaleString();

                        baseData[`Payee${suffix}`] = item.name;
                        baseData[`Bank${suffix}`] = bankText;
                        baseData[`Branch${suffix}`] = branchText;
                        baseData[`Amt${suffix}`] = fmtAmt;
                        
                        const bCode = String(item.code || "");
                        for (let k = 1; k <= 7; k++) baseData[`B${k}${suffix}`] = bCode[k-1] || "";
                        
                        const acc = String(item.account || "");
                        for (let k = 1; k <= 14; k++) baseData[`A${k}${suffix}`] = acc[k-1] || "";
                    } else {
                        // Empty row
                        baseData[`Payee${suffix}`] = "";
                        baseData[`Bank${suffix}`] = "銀行";
                        baseData[`Branch${suffix}`] = "      分行";
                        baseData[`Amt${suffix}`] = "";
                        for (let k = 1; k <= 7; k++) baseData[`B${k}${suffix}`] = "";
                        for (let k = 1; k <= 14; k++) baseData[`A${k}${suffix}`] = "";
                    }
                }
                return baseData;
            };

            // --- Handlers (Existing) ---
            const handleImportBatchCSV = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {type:'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws, {header: 1});
                        const newItems = [];
                        for(let i=1; i<data.length; i++) {
                            const row = data[i];
                            if(row.length > 7 && row[1]) {
                                newItems.push({
                                    id: Date.now() + i,
                                    name: row[1],
                                    bank: row[2] || '',
                                    branch: row[3] || '',
                                    code: cleanCode(row[4]),
                                    account: cleanAccount(row[5]),
                                    amount: String(row[7] || '').replace(/[^0-9]/g, '')
                                });
                            }
                        }
                        if(newItems.length > 0 && confirm(`成功讀取 ${newItems.length} 筆資料。匯入？`)) {
                            setBatchItems(prev => [...prev, ...newItems]);
                        } else { alert("讀取不到有效資料。"); }
                    } catch(err) { alert("匯入失敗：" + err.message); }
                    e.target.value = '';
                };
                reader.readAsBinaryString(file);
            };

            const handleBackupSystem = () => {
                const backupData = { version: "1.0", timestamp: new Date().toISOString(), settings, payees };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `系統備份_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleRestoreSystem = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if(data.settings && data.payees && confirm(`確定還原？含 ${data.payees.length} 筆廠商。`)) {
                            setSettings(data.settings);
                            setPayees(data.payees);
                            alert("還原成功！");
                        }
                    } catch(err) { alert("解析失敗"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const handleDownloadVendorTemplate = () => {
                const headers = ["廠商名稱", "銀行名稱", "分行名稱", "銀行代碼", "銀行帳號"];
                const data = [headers, ["範例廠商", "台灣銀行", "總行", "004", "0123456789"]];
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 20 }];
                
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(let R = 1; R <= range.e.r; ++R) {
                    const colCode = XLSX.utils.encode_cell({r: R, c: 3});
                    const colAcct = XLSX.utils.encode_cell({r: R, c: 4});
                    if(ws[colCode]) { ws[colCode].z = '@'; ws[colCode].t = 's'; }
                    if(ws[colAcct]) { ws[colAcct].z = '@'; ws[colAcct].t = 's'; }
                }
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "廠商資料");
                XLSX.writeFile(wb, "廠商匯入範本.xlsx");
            };

            const handleImportVendors = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws, {header: 1});
                        if(data.length < 2) { alert("檔案似乎是空的"); return; }
                        const newVendors = [];
                        for(let i=1; i<data.length; i++) {
                            const row = data[i];
                            if(row[0]) {
                                newVendors.push({
                                    id: Date.now() + i,
                                    name: String(row[0]),
                                    bank: String(row[1] || ''),
                                    branch: String(row[2] || ''),
                                    code: String(row[3] || '').trim(),
                                    account: cleanAccount(row[4])
                                });
                            }
                        }
                        if(newVendors.length > 0 && confirm(`成功讀取 ${newVendors.length} 筆資料。匯入？`)) {
                            setPayees(prev => [...prev, ...newVendors]);
                            alert(`匯入完成！成功加入 ${newVendors.length} 筆資料。`);
                        } else { alert("無有效資料。"); }
                    } catch(err) { alert("匯入失敗：" + err.message); }
                    e.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            };

            const handleVendorFormChange = (e) => {
                const { name, value } = e.target;
                setVendorForm(prev => ({ ...prev, [name]: value }));
            };

            const handleVendorSubmit = (e) => {
                e.preventDefault();
                const processedForm = { ...vendorForm, code: cleanCode(vendorForm.code), account: cleanAccount(vendorForm.account) };
                if (editingVendorId) {
                    setPayees(prev => prev.map(p => p.id === editingVendorId ? { ...p, ...processedForm } : p));
                    setBatchItems(prev => prev.map(item => item.vendorId === editingVendorId ? { ...item, ...processedForm } : item));
                    alert("更新成功！");
                    handleCancelEdit();
                } else {
                    setPayees(prev => [...prev, { id: Date.now(), ...processedForm }]);
                    setVendorForm({ name: '', bank: '', branch: '', code: '', account: '' });
                }
            };

            const handleVendorClick = (payee) => {
                if (editingVendorId === payee.id) handleCancelEdit();
                else { setEditingVendorId(payee.id); setVendorForm({ name: payee.name, bank: payee.bank, branch: payee.branch, code: payee.code, account: payee.account }); }
            };
            const handleCancelEdit = () => { setEditingVendorId(null); setVendorForm({ name: '', bank: '', branch: '', code: '', account: '' }); };
            const handleDeletePayee = (e, id) => { e.stopPropagation(); if(confirm("確定刪除？")) { setPayees(payees.filter(p => p.id !== id)); if(id === editingVendorId) handleCancelEdit(); if(String(id) === selectedPayeeId) setSelectedPayeeId(''); }};
            const filteredPayees = useMemo(() => { if (!searchTerm) return payees; const lowerTerm = searchTerm.toLowerCase(); return payees.filter(p => (p.name && p.name.toLowerCase().includes(lowerTerm)) || (p.bank && p.bank.toLowerCase().includes(lowerTerm))); }, [payees, searchTerm]);
            const selectedPayeeData = useMemo(() => payees.find(p => p.id === parseInt(selectedPayeeId)), [selectedPayeeId, payees]);
            const handleAddItem = () => { if (!selectedPayeeData || !amount) return; setBatchItems([...batchItems, { ...selectedPayeeData, vendorId: selectedPayeeData.id, amount: amount, id: Date.now() }]); setAmount(''); };
            const handleRemoveItem = (id) => setBatchItems(batchItems.filter(item => item.id !== id));
            const handleClearBatch = () => { if(window.confirm('確定清空？')) setBatchItems([]); };

            return (
                <div className="min-h-screen bg-gray-100 p-4 font-sans text-gray-800 pb-20">
                    <div className="max-w-6xl mx-auto space-y-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-600 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <IconUsers /> 大宗郵政跨行匯款小幫手
                                </h1>
                                <p className="text-sm text-gray-500 mt-1">v20 (合併列印完整版)</p>
                            </div>
                            <div className="text-right text-sm text-gray-500 bg-gray-50 px-4 py-2 rounded-lg w-full md:w-auto">
                                <div className="flex justify-between md:block"><span>目前筆數:</span> <span className="font-bold text-blue-600 text-lg ml-2">{batchItems.length}</span></div>
                                <div className="flex justify-between md:block"><span>預計頁數:</span> <span className="font-bold text-gray-800 ml-2">{Math.ceil(batchItems.length / 7)}</span></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            {/* Left Column */}
                            <div className="lg:col-span-4 space-y-4">
                                <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 ring-2 ring-blue-50">
                                    <button onClick={() => setIsBackupOpen(!isBackupOpen)} className="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-gray-700 font-bold">
                                        <div className="flex items-center gap-2"><IconDatabase /> 資料載入與備份設定</div>
                                        <div className={`transition-transform ${isBackupOpen ? 'rotate-90' : ''}`}><IconArrow /></div>
                                    </button>
                                    {isBackupOpen && (
                                        <div className="p-4 space-y-4 border-t border-gray-100">
                                            <div className={`p-3 rounded-lg border flex flex-col gap-2 transition-colors ${storageEnabled ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                <div className="flex justify-between items-center">
                                                    <span className={`font-bold text-sm ${storageEnabled ? 'text-green-800' : 'text-red-800'}`}>{storageEnabled ? '已啟用瀏覽器暫存' : '已停用瀏覽器暫存'}</span>
                                                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                        <input type="checkbox" name="toggle" id="toggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out" checked={storageEnabled} onChange={(e) => setStorageEnabled(e.target.checked)} style={{ right: storageEnabled ? '0' : 'unset', left: storageEnabled ? 'unset' : '0', borderColor: storageEnabled ? '#16a34a' : '#ef4444' }} />
                                                        <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer border ${storageEnabled ? 'bg-green-500 border-green-500' : 'bg-gray-300 border-gray-300'}`}></label>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-500">{storageEnabled ? '資料會自動儲存在此電腦的瀏覽器中。' : '安全模式：資料僅暫存於記憶體，關閉視窗後清除。'}</div>
                                            </div>
                                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm">
                                                <div className="font-bold text-blue-800 mb-2">全系統備份 (廠商 + 設定)</div>
                                                <div className="flex gap-2">
                                                    <button onClick={handleBackupSystem} className="flex-1 bg-white text-blue-700 border border-blue-200 py-2 rounded font-bold hover:bg-blue-50 shadow-sm">匯出 JSON</button>
                                                    <button onClick={() => jsonInputRef.current.click()} className="flex-1 bg-blue-600 text-white border border-blue-600 py-2 rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-1 shadow-sm"><IconUpload/> 載入 JSON</button>
                                                    <input type="file" ref={jsonInputRef} onChange={handleRestoreSystem} className="hidden" accept=".json" />
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Settings */}
                                <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                                    <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-gray-700 font-bold">
                                        <div className="flex items-center gap-2"><IconSettings /> 匯款人設定</div>
                                        <div className={`transition-transform ${isSettingsOpen ? 'rotate-90' : ''}`}><IconArrow /></div>
                                    </button>
                                    {isSettingsOpen && (
                                        <div className="p-5 space-y-3 text-sm border-t border-gray-100">
                                            <div className="font-bold text-blue-600">匯款人</div>
                                            <input type="text" value={settings.remitterName} onChange={(e)=>setSettings(p=>({...p, remitterName: e.target.value}))} className="w-full border p-2 rounded" placeholder="名稱" />
                                            <input type="text" value={settings.remitterId} onChange={(e)=>setSettings(p=>({...p, remitterId: e.target.value}))} className="w-full border p-2 rounded" placeholder="統編" />
                                            <input type="text" value={settings.remitterPhone} onChange={(e)=>setSettings(p=>({...p, remitterPhone: e.target.value}))} className="w-full border p-2 rounded" placeholder="電話" />
                                            <div className="flex gap-2 flex-col">
                                                <input type="text" value={settings.remitterZip} onChange={(e)=>setSettings(p=>({...p, remitterZip: e.target.value}))} className="w-full border p-2 rounded font-bold text-gray-700" placeholder="郵遞區號 (3+2碼)" />
                                                { (!settings.remitterZip || settings.remitterZip.length !== 5) && <div className="text-[10px] text-red-500 flex items-center gap-1 px-1"><IconAlert/> 請務必填寫完整 5 碼 (3+2) 以確保列印格式正確</div> }
                                                <input type="text" value={settings.remitterAddr} onChange={(e)=>setSettings(p=>({...p, remitterAddr: e.target.value}))} className="w-full border p-2 rounded" placeholder="地址" />
                                            </div>
                                            <div className="border-t pt-2 font-bold text-green-600">代理人</div>
                                            <input type="text" value={settings.agentName} onChange={(e)=>setSettings(p=>({...p, agentName: e.target.value}))} className="w-full border p-2 rounded" placeholder="姓名" />
                                            <input type="text" value={settings.agentId} onChange={(e)=>setSettings(p=>({...p, agentId: e.target.value}))} className="w-full border p-2 rounded" placeholder="身分證" />
                                            <input type="text" value={settings.agentPhone} onChange={(e)=>setSettings(p=>({...p, agentPhone: e.target.value}))} className="w-full border p-2 rounded" placeholder="電話" />
                                        </div>
                                    )}
                                </div>

                                {/* Vendor Mgr */}
                                <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                                    <button onClick={() => setIsVendorMgrOpen(!isVendorMgrOpen)} className="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-gray-700 font-bold">
                                        <div className="flex items-center gap-2"><IconDisk /> 廠商資料庫管理</div>
                                        <div className={`transition-transform ${isVendorMgrOpen ? 'rotate-90' : ''}`}><IconArrow /></div>
                                    </button>
                                    {isVendorMgrOpen && (
                                        <div className="p-4 space-y-4 border-t border-gray-100">
                                            <div className="bg-purple-50 p-3 rounded-lg border border-purple-100 text-sm mb-4">
                                                <div className="font-bold text-purple-800 mb-2 flex items-center gap-1"><IconTable /> 批次匯入廠商</div>
                                                <div className="flex gap-2">
                                                    <button onClick={handleDownloadVendorTemplate} className="flex-1 bg-white text-purple-700 border border-purple-200 py-2 rounded font-bold hover:bg-purple-50 shadow-sm flex items-center justify-center gap-1"><IconDownload/> 下載 Excel 範本</button>
                                                    <button onClick={() => vendorFileInputRef.current.click()} className="flex-1 bg-purple-600 text-white border border-purple-600 py-2 rounded font-bold hover:bg-purple-700 flex items-center justify-center gap-1 shadow-sm"><IconUpload/> 匯入 Excel</button>
                                                    <input type="file" ref={vendorFileInputRef} onChange={handleImportVendors} className="hidden" accept=".csv, .xlsx, .xls" />
                                                </div>
                                                <div className="mt-2 text-xs text-purple-600">
                                                    * 支援 .xlsx, .xls, .csv 格式 (Excel 編輯時請按 Ctrl+1 將儲存格格式改為「文字」以免遺漏 0)
                                                </div>
                                            </div>
                                            <form onSubmit={handleVendorSubmit} className={`space-y-2 p-3 rounded border text-sm transition-colors ${editingVendorId ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className={`font-bold ${editingVendorId ? 'text-orange-700' : 'text-gray-600'}`}>{editingVendorId ? '編輯廠商模式' : '手動新增廠商'}</div>
                                                    {editingVendorId && <button type="button" onClick={handleCancelEdit} className="text-xs bg-white border px-2 py-1 rounded text-gray-500 hover:text-gray-700 flex items-center gap-1"><IconClose /> 取消</button>}
                                                </div>
                                                <input name="name" value={vendorForm.name} onChange={handleVendorFormChange} required className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="廠商名稱" />
                                                <div className="flex gap-2">
                                                    <input name="bank" value={vendorForm.bank} onChange={handleVendorFormChange} required className="w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="銀行名" />
                                                    <input name="branch" value={vendorForm.branch} onChange={handleVendorFormChange} className="w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="分行名" />
                                                </div>
                                                <div className="flex gap-2">
                                                    <input name="code" value={vendorForm.code} onChange={handleVendorFormChange} className="w-1/3 p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="代碼" />
                                                    <input name="account" value={vendorForm.account} onChange={handleVendorFormChange} required className="w-2/3 p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="帳號" />
                                                </div>
                                                <button type="submit" className={`w-full py-1.5 rounded font-bold text-white transition-colors ${editingVendorId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-700 hover:bg-gray-800'}`}>{editingVendorId ? '儲存修改' : '新增'}</button>
                                            </form>
                                            <div className="max-h-56 overflow-y-auto border rounded text-sm bg-white">
                                                {payees.length === 0 && <div className="p-4 text-center text-gray-400">無資料 (請匯入備份或手動新增)</div>}
                                                {payees.map(p => (
                                                    <div key={p.id} onClick={() => handleVendorClick(p)} className={`vendor-item flex justify-between items-center p-2 border-b last:border-0 group ${editingVendorId === p.id ? 'active' : 'hover:bg-gray-50'}`}>
                                                        <div className="overflow-hidden">
                                                            <div className={`font-bold truncate ${editingVendorId === p.id ? 'text-blue-700' : 'text-gray-800'}`}>{p.name}</div>
                                                            <div className="text-xs text-gray-500 truncate">{p.bank} ({p.code}) - {p.account}</div>
                                                        </div>
                                                        <button onClick={(e) => handleDeletePayee(e, p.id)} className={`p-2 rounded-full transition-colors ${editingVendorId === p.id ? 'text-red-400 hover:bg-red-100' : 'text-gray-300 hover:text-red-500 group-hover:bg-gray-100'}`}><IconTrash /></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Main Input */}
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-blue-100 relative">
                                    <div className="absolute top-0 right-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-bl-lg font-bold">輸入區</div>
                                    <h2 className="font-bold text-blue-800 mb-4 flex items-center gap-2"><IconPlus /> 新增匯款項目</h2>
                                    <div className="space-y-4">
                                        <div className="relative"><input type="text" className="w-full p-2 border rounded-lg text-sm bg-gray-50" placeholder="搜尋廠商..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                        <select value={selectedPayeeId} onChange={(e) => setSelectedPayeeId(e.target.value)} className="w-full border p-2 rounded-lg text-sm" size={filteredPayees.length > 5 ? 5 : 1}>
                                            <option value="">-- 請選擇廠商 --</option>
                                            {filteredPayees.map(p => <option key={p.id} value={p.id}>{p.name} ({p.bank})</option>)}
                                        </select>
                                        {selectedPayeeData ? (
                                            <div className="bg-blue-50 p-3 rounded-lg text-xs space-y-1 border border-blue-100 shadow-inner">
                                                <div className="font-bold text-blue-900 border-b border-blue-200 pb-1 mb-1">{selectedPayeeData.name}</div>
                                                <div className="flex justify-between text-blue-800"><span>銀行:</span> <span>{selectedPayeeData.code} {selectedPayeeData.bank}</span></div>
                                                <div className="flex justify-between text-blue-800"><span>分行:</span> <span>{selectedPayeeData.branch}</span></div>
                                                <div className="flex justify-between text-blue-800"><span>帳號:</span> <span className="font-mono font-bold tracking-wider">{selectedPayeeData.account}</span></div>
                                            </div>
                                        ) : ( <div className="h-20 bg-gray-50 rounded-lg flex items-center justify-center text-gray-400 text-xs border border-dashed border-gray-300">請先選擇廠商</div> )}
                                        <div className="relative">
                                            <span className="absolute left-3 top-2 text-gray-400 font-bold">$</span>
                                            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddItem()} className="w-full border rounded-lg pl-7 p-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="金額" />
                                        </div>
                                        <button onClick={handleAddItem} disabled={!selectedPayeeData || !amount} className={`w-full py-3 rounded-lg font-bold text-white flex justify-center items-center gap-2 transition-all ${!selectedPayeeData || !amount ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg'}`}>
                                            <IconPlus /> 加入清單
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Right Column */}
                            <div className="lg:col-span-8 flex flex-col h-full space-y-4">
                                <div className="bg-white rounded-xl shadow-sm flex-grow flex flex-col overflow-hidden border border-gray-200 min-h-[500px]">
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <h2 className="font-bold text-gray-700 flex items-center gap-2">匯款清單預覽</h2>
                                        <div className="flex gap-2">
                                            <button onClick={()=>batchFileInputRef.current.click()} className="text-blue-500 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><IconUpload /> 載入 CSV</button>
                                            <input type="file" className="hidden" ref={batchFileInputRef} onChange={handleImportBatchCSV} accept=".csv" />
                                            {batchItems.length > 0 && <button onClick={handleClearBatch} className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold flex items-center gap-1"><IconTrash /> 清空</button>}
                                        </div>
                                    </div>
                                    <div className="overflow-y-auto flex-grow p-0 relative">
                                        {batchItems.length === 0 ? (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-300"><p>尚未加入任何項目</p></div>
                                        ) : (
                                            <table className="min-w-full divide-y divide-gray-100 table-fixed">
                                                <thead className="bg-gray-50 sticky top-0 shadow-sm z-10">
                                                    <tr>
                                                        <th className="w-10 px-1 py-3 text-center text-xs font-bold text-gray-400">#</th>
                                                        <th className="w-10 px-2 py-3 text-left text-xs font-bold text-gray-500">序</th>
                                                        <th className="w-32 px-2 py-3 text-left text-xs font-bold text-gray-500">廠商</th>
                                                        <th className="px-2 py-3 text-left text-xs font-bold text-gray-500">代碼 / 銀行</th>
                                                        <th className="w-24 px-2 py-3 text-right text-xs font-bold text-gray-500">金額</th>
                                                        <th className="w-10 px-1 py-3 text-center text-xs font-bold text-gray-500">刪</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100 bg-white">
                                                    {batchItems.map((item, index) => (
                                                        <tr key={item.id} className="hover:bg-blue-50 transition-colors">
                                                            <td className="px-1 py-2 text-center">
                                                                <div className="flex flex-col items-center gap-1">
                                                                    <button onClick={() => moveItem(index, -1)} disabled={index === 0} className={`p-1 rounded ${index === 0 ? 'text-gray-200 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-200 hover:text-gray-700'}`}><IconChevronUp /></button>
                                                                    <button onClick={() => moveItem(index, 1)} disabled={index === batchItems.length - 1} className={`p-1 rounded ${index === batchItems.length - 1 ? 'text-gray-200 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-200 hover:text-gray-700'}`}><IconChevronDown /></button>
                                                                </div>
                                                            </td>
                                                            <td className="px-2 py-3 text-xs text-gray-400 font-mono align-middle">{(index%7)+1}</td>
                                                            <td className="px-2 py-3 text-sm font-medium text-gray-800 align-middle truncate">{item.name}</td>
                                                            <td className="px-2 py-3 text-xs text-gray-500 align-middle">
                                                                <span className="font-bold text-blue-700 mr-2">{item.code}</span>
                                                                {item.bank} <span className="text-gray-400">({item.branch})</span>
                                                                <div className="font-mono text-gray-400 text-[10px] truncate">{item.account}</div>
                                                            </td>
                                                            <td className="px-2 py-3 text-right align-middle"><input type="number" value={item.amount} onChange={(e) => updateItemAmount(item.id, e.target.value)} className="w-full text-right text-sm font-bold text-blue-600 bg-transparent border-b border-transparent hover:border-blue-200 focus:border-blue-500 focus:outline-none px-1" /></td>
                                                            <td className="px-1 py-3 text-center align-middle"><button onClick={() => handleRemoveItem(item.id)} className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors"><IconTrash /></button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                                    <button onClick={handleExportCSV} disabled={batchItems.length === 0} className={`w-full py-4 rounded-xl font-bold text-white flex justify-center items-center gap-2 text-lg shadow-lg transform transition-all active:scale-95 ${batchItems.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-600 hover:bg-gray-700'}`}>
                                        <IconDownload /> 下載 Word 合併列印檔 (.csv)
                                    </button>
                                    
                                    <div className="relative">
                                        <button onClick={handleGenerateWord} disabled={batchItems.length === 0} className={`w-full py-4 rounded-xl font-bold text-white flex justify-center items-center gap-2 text-lg shadow-lg transform transition-all active:scale-95 ${batchItems.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                                            <IconFileWord /> 下載 Word (.docx) 自動生成
                                        </button>
                                        <input type="file" ref={templateInputRef} onChange={handleTemplateSelect} className="hidden" accept=".docx" />
                                    </div>
                                </div>

                                {/* Instruction Section */}
                                <div className="bg-white rounded-xl shadow-sm border-l-4 border-purple-600 overflow-hidden mt-4">
                                    <button onClick={toggleInstructions} className="w-full flex items-center justify-between p-4 bg-white hover:bg-gray-50 transition-colors text-gray-800 font-bold">
                                        <div className="flex items-center gap-2"><IconFileWord className="text-purple-600" /> Word 操作教學 (僅供 CSV 模式參考)</div>
                                        <div className={`transition-transform ${isInstructionsOpen ? 'rotate-90' : ''}`}><IconArrow /></div>
                                    </button>
                                    {isInstructionsOpen && (
                                        <div className="p-6 border-t border-gray-100 bg-white">
                                            <div className="flex flex-col gap-4">
                                                <div className="flex flex-wrap gap-3 items-center">
                                                    <a href="大宗郵政跨行匯款_合併列印.docx" className="inline-flex items-center justify-center gap-2 bg-purple-100 text-purple-700 px-4 py-3 rounded-lg font-bold hover:bg-purple-200 transition-colors border border-purple-200 w-fit">
                                                        <IconDownload /> 下載官方範本檔 (.docx)
                                                    </a>
                                                    <a href="http://www.post.gov.tw/post/internet/Download/all_list.jsp?ID=2201#dl_link_512" target="_blank" rel="noopener noreferrer" className="text-purple-600 hover:text-purple-800 underline text-sm flex items-center gap-1">
                                                        <IconExternalLink /> 原始檔案來源 (中華郵政)
                                                    </a>
                                                </div>
                                                <div className="text-sm text-gray-500">
                                                    * 若使用新的「自動生成」按鈕，您只需準備一個命名為 <code>template.docx</code> 的範本檔放在同目錄下即可，無需手動合併列印。
                                                </div>
                                                
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                                        <span className="font-bold text-purple-600 block mb-1">STEP 1</span>
                                                        開啟 Word 檔時，若出現 SQL 命令提示視窗，請務必按 <strong className="text-red-600">「否 (No)」</strong>。
                                                    </div>
                                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                                        <span className="font-bold text-purple-600 block mb-1">STEP 2</span>
                                                        上方選單「郵件」→「選取收件者」→「使用現有清單」，選擇剛下載的 .csv 檔。
                                                    </div>
                                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                                        <span className="font-bold text-purple-600 block mb-1">STEP 3</span>
                                                        檔案轉換視窗中，選擇編碼 <strong className="text-blue-600">UTF-8 (Unicode)</strong>，分隔符號選「逗號」。
                                                    </div>
                                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                                        <span className="font-bold text-purple-600 block mb-1">STEP 4</span>
                                                        點選「預覽結果」檢查資料，確認無誤後按「完成與合併」→「編輯個別文件」。
                                                    </div>
                                                </div>

                                                <div className="flex items-start gap-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-sm text-yellow-800">
                                                    <div className="mt-0.5"><IconAlert /></div>
                                                    <div>
                                                        <strong>注意：</strong> 合併列印後，文件最後可能會自動產生空白頁，列印前請先預覽或手動刪除該頁。
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>